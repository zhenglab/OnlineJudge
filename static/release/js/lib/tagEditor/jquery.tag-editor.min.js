define("tagEditor",["jquery"],function(e){!function(e){e.fn.autoGrowInput=function(n){return n=e.extend({maxWidth:250,minWidth:20,comfortZone:0},n),this.filter("input:text").each(function(){var r=(n.minWidth||e(this).width()," "),i=e(this),s=n.comfortZone?n.comfortZone:parseInt(.9*parseInt(e(this).css("fontSize"))),o=e("<dummy/>").css({position:"absolute",top:-9999,left:-9999,width:"auto",fontSize:i.css("fontSize"),fontFamily:i.css("fontFamily"),fontWeight:i.css("fontWeight"),letterSpacing:i.css("letterSpacing"),whiteSpace:"nowrap"}),u=function(){if(r!==(r=i.val())){o.html(r.replace(/&/g,"&amp;").replace(/\s/g,"&nbsp;").replace(/</g,"&lt;").replace(/>/g,"&gt;"));var e=o.width()+s;e>n.maxWidth&&(e=n.maxWidth),e<n.minWidth&&(e=n.minWidth),e!=i.width()&&i.width(e)}};o.insertAfter(i),e(this).bind("keyup keydown blur focus autogrow",u)}),this},!function(e){e.fn.caret=function(e){var t=this[0],n="true"===t.contentEditable;if(0==arguments.length){if(window.getSelection){if(n){t.focus();var r=window.getSelection().getRangeAt(0),i=r.cloneRange();return i.selectNodeContents(t),i.setEnd(r.endContainer,r.endOffset),i.toString().length}return t.selectionStart}if(document.selection){if(t.focus(),n){var r=document.selection.createRange(),i=document.body.createTextRange();return i.moveToElementText(t),i.setEndPoint("EndToEnd",r),i.text.length}var e=0,s=t.createTextRange(),i=document.selection.createRange().duplicate(),o=i.getBookmark();for(s.moveToBookmark(o);0!==s.moveStart("character",-1);)e++;return e}return 0}if(-1==e&&(e=this[n?"text":"val"]().length),window.getSelection)n?(t.focus(),window.getSelection().collapse(t.firstChild,e)):t.setSelectionRange(e,e);else if(document.body.createTextRange)if(n){var s=document.body.createTextRange();s.moveToElementText(t),s.moveStart("character",e),s.collapse(!0),s.select()}else{var s=t.createTextRange();s.move("character",e),s.select()}return n||t.focus(),e}}(jQuery),e.fn.tagEditor=function(n,r,s){function o(n){if(8==n.which||46==n.which||n.ctrlKey&&88==n.which){var r=getSelection(),s=e(r.getRangeAt(0).commonAncestorContainer);if(s.hasClass("tag-editor")){var o=[],u=r.toString().split(s.prev().data("options").dregex);for(i=0;i<u.length;i++){var a=e.trim(u[i]);a&&o.push(a)}return e(".tag-editor-tag",s).each(function(){~e.inArray(e(this).html(),o)&&e(this).closest("li").find(".tag-editor-delete").click()}),!1}}}var u,a=e.extend({},e.fn.tagEditor.defaults,n),f=this;if(a.dregex=new RegExp("["+a.delimiter.replace("-","-")+"]","g"),"string"==typeof n){var l=[];return f.each(function(){var i=e(this),o=i.data("options"),u=i.next(".tag-editor");"getTags"==n?l.push({field:i[0],editor:u,tags:u.data("tags")}):"addTag"==n?(e('<li><div class="tag-editor-spacer">&nbsp;'+o.delimiter[0]+'</div><div class="tag-editor-tag"></div><div class="tag-editor-delete"><i></i></div></li>').appendTo(u).find(".tag-editor-tag").html('<input type="text" maxlength="'+o.maxLength+'">').addClass("active").find("input").val(r).blur(),"blur"!=s?u.click():e(".placeholder",u).remove()):"removeTag"==n?(e(".tag-editor-tag",u).filter(function(){return e(this).html()==r}).closest("li").find(".tag-editor-delete").click(),"blur"!=s&&u.click()):"destroy"==n&&i.css("display",o.elDisplay).removeData("options").next(".tag-editor").remove()}),l}return window.getSelection&&e(document).off("keydown.tag-editor").on("keydown.tag-editor",o),f.each(function(){function n(){!a.placeholder||f.length||e(".deleted, .placeholder, input",l).length||l.append('<li class="placeholder"><div>'+a.placeholder+"</div></li>")}function r(r){var i=f.toString();f=e(".tag-editor-tag:not(.deleted)",l).map(function(n,r){var i=e.trim(e(this).hasClass("active")?e(this).find("input").val():e(r).text());return i?i:void 0}).get(),l.data("tags",f),o.val(f.join(a.delimiter[0])),r||i!=f.toString()&&a.onChange(o,l,f),n()}function s(n){var s=n.closest("li"),u=n.val().replace(/ +/," ").split(a.dregex),c=n.data("old_tag"),h=f.slice(0);for(i in u)v=e.trim(u[i]).slice(0,a.maxLength),v&&(a.forceLowercase&&(v=v.toLowerCase()),a.beforeTagSave(o,l,h,c,v),~e.inArray(v,h)&&e(".tag-editor-tag",l).each(function(){e(this).html()==v&&e(this).closest("li").remove()}),h.push(v),s.before('<li><div class="tag-editor-spacer">&nbsp;'+a.delimiter[0]+'</div><div class="tag-editor-tag">'+v+'</div><div class="tag-editor-delete"><i></i></div></li>'));n.attr("maxlength",a.maxLength).removeData("old_tag").val("").focus(),r()}var o=e(this),f=[];a.elDisplay=o.css("display"),o.css("display","none");var l=e("<ul "+(a.clickDelete?'oncontextmenu="return false;" ':"")+'class="tag-editor"></ul>').insertAfter(o);o.data("options",a),l.append('<li style="width:.1px">&nbsp;</li>');var c='<li><div class="tag-editor-spacer">&nbsp;'+a.delimiter[0]+'</div><div class="tag-editor-tag"></div><div class="tag-editor-delete"><i></i></div></li>';l.click(function(n){if(!window.getSelection||""==getSelection()){if(u=!0,e("input:focus",l).blur(),!u)return!1;u=!0,e(".placeholder",l).remove();var r,i,s,o=99999;return e(".tag-editor-tag",l).each(function(){var u=e(this),a=u.offset(),f=a.left,l=a.top;n.pageY>=l&&n.pageY<=l+u.height()&&(n.pageX<f?(s="before",r=f-n.pageX):(s="after",r=n.pageX-f-u.width()),o>r&&(o=r,i=u))}),"before"==s?e(c).insertBefore(i.closest("li")).find(".tag-editor-tag").click():"after"==s?e(c).insertAfter(i.closest("li")).find(".tag-editor-tag").click():e(c).appendTo(l).find(".tag-editor-tag").click(),!1}}),l.on("click",".tag-editor-delete",function(){if(e(this).prev().hasClass("active"))return e(this).closest("li").find("input").caret(-1),!1;var i=e(this).closest("li"),s=i.find(".tag-editor-tag");return a.beforeTagDelete(o,l,f,s.html())===!1?!1:(s.addClass("deleted").animate({width:0},175,function(){i.remove(),n()}),r(),!1)}),a.clickDelete&&l.on("mousedown",".tag-editor-tag",function(i){if(i.ctrlKey||i.which>1){var s=e(this).closest("li"),u=s.find(".tag-editor-tag");return a.beforeTagDelete(o,l,f,u.html())===!1?!1:(u.addClass("deleted").animate({width:0},175,function(){s.remove(),n()}),r(),!1)}}),l.on("click",".tag-editor-tag",function(n){if(a.clickDelete&&(n.ctrlKey||n.which>1))return!1;if(!e(this).hasClass("active")){var r=e(this).html(),i=Math.abs((e(this).offset().left-n.pageX)/e(this).width()),s=parseInt(r.length*i),o=e(this).html('<input type="text" maxlength="'+a.maxLength+'" value="'+r+'">').addClass("active").find("input");if(o.data("old_tag",r).focus().autoGrowInput().trigger("autogrow").caret(s),a.autocomplete){var u=a.autocomplete,f="select"in u?a.autocomplete.select:"";u.select=function(){f&&f(),setTimeout(function(){e(".active",l).find("input").trigger("autogrow")},20)},o.autocomplete(u)}}return!1}),l.on("blur","input",function(){var i=e(this),c=i.data("old_tag"),h=e.trim(i.val().replace(/ +/," ").replace(a.dregex,a.delimiter[0]));if(h){if(h.indexOf(a.delimiter[0])>=0)return void s(i);h!=c&&(a.forceLowercase&&(h=h.toLowerCase()),a.beforeTagSave(o,l,f,c,h),e(".tag-editor-tag:not(.active)",l).each(function(){e(this).html()==h&&e(this).closest("li").remove()}))}else{if(c&&a.beforeTagDelete(o,l,f,c)===!1)return i.val(c).trigger("autogrow").focus(),u=!1,void r();try{i.closest("li").remove()}catch(p){}c&&r()}i.parent().html(h).removeClass("active"),h!=c&&r(),n()});var h;l.on("paste","input",function(){e(this).removeAttr("maxlength"),h=e(this),setTimeout(function(){s(h)},30)});var p;l.on("keypress","input",function(n){a.delimiter.indexOf(String.fromCharCode(n.which))>=0&&(p=e(this),setTimeout(function(){s(p)},20))}),l.on("keydown","input",function(n){var r=e(this);if((37==n.which||!a.autocomplete&&38==n.which)&&!r.caret()||8==n.which&&!r.val()){var i=r.closest("li").prev("li").find(".tag-editor-tag");return i.length?i.click().find("input").caret(-1):r.val()&&e(c).insertBefore(r.closest("li")).find(".tag-editor-tag").click(),!1}if((39==n.which||!a.autocomplete&&40==n.which)&&r.caret()==r.val().length){var s=r.closest("li").next("li").find(".tag-editor-tag");return s.length?s.click().find("input").caret(0):r.val()&&l.click(),!1}if(9==n.which){if(n.shiftKey){var i=r.closest("li").prev("li").find(".tag-editor-tag");i.length?i.click().find("input").caret(0):r.val()&&e(c).insertBefore(r.closest("li")).find(".tag-editor-tag").click()}else{var s=r.closest("li").next("li").find(".tag-editor-tag");s.length?s.click().find("input").caret(0):r.val()&&l.click()}return!1}if(!(46!=n.which||e.trim(r.val())&&r.caret()!=r.val().length)){var s=r.closest("li").next("li").find(".tag-editor-tag");return s.length?s.click().find("input").caret(0):r.val()&&l.click(),!1}if(13==n.which){var s=r.closest("li").next("li").find(".tag-editor-tag");return s.length?s.click().find("input").caret(0):r.val()&&l.click(),!1}if(36!=n.which||r.caret()){if(35==n.which&&r.caret()==r.val().length)l.find(".tag-editor-tag").last().click();else if(27==n.which)return r.val(r.data("old_tag")?r.data("old_tag"):"").blur(),!1}else l.find(".tag-editor-tag").first().click()});var d=a.initialTags.length?a.initialTags:o.val().split(a.dregex);for(i in d){var v=e.trim(d[i].replace(/ +/," "));v&&(a.forceLowercase&&(v=v.toLowerCase()),f.push(v),l.append('<li><div class="tag-editor-spacer">&nbsp;'+a.delimiter[0]+'</div><div class="tag-editor-tag">'+v+'</div><div class="tag-editor-delete"><i></i></div></li>'))}r(!0),a.sortable&&e.fn.sortable&&l.sortable({distance:5,cancel:".tag-editor-spacer, input",helper:"clone",update:function(){r()}})})},e.fn.tagEditor.defaults={initialTags:[],maxLength:50,delimiter:",;",placeholder:"",forceLowercase:!0,clickDelete:!1,sortable:!0,autocomplete:null,onChange:function(){},beforeTagSave:function(){},beforeTagDelete:function(){}}}(jQuery)});